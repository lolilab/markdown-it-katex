"use strict";var katex=require("katex");function isValidDelim(e,r){var t,n,c=e.posMax,i=!0,a=!0;return t=r>0?e.src.charCodeAt(r-1):-1,n=r+1<=c?e.src.charCodeAt(r+1):-1,(32===t||9===t||n>=48&&n<=57)&&(a=!1),32!==n&&9!==n||(i=!1),{can_open:i,can_close:a}}function math_inline(e,r){var t,n,c,i;if("$"!==e.src[e.pos])return!1;if(!isValidDelim(e,e.pos).can_open)return r||(e.pending+="$"),e.pos+=1,!0;for(n=t=e.pos+1;-1!==(n=e.src.indexOf("$",n));){for(i=n-1;"\\"===e.src[i];)i-=1;if((n-i)%2==1)break;n+=1}return-1===n?(r||(e.pending+="$"),e.pos=t,!0):n-t==0?(r||(e.pending+="$$"),e.pos=t+1,!0):isValidDelim(e,n).can_close?(r||((c=e.push("math_inline","math",0)).markup="$",c.content=e.src.slice(t,n)),e.pos=n+1,!0):(r||(e.pending+="$"),e.pos=t,!0)}function math_block(e,r,t,n){var c,i,a,l,s,o=!1,p=e.bMarks[r]+e.tShift[r],u=e.eMarks[r];if(p+2>u)return!1;if("$$"!==e.src.slice(p,p+2))return!1;if(p+=2,c=e.src.slice(p,u),n)return!0;for("$$"===c.trim().slice(-2)&&(c=c.trim().slice(0,-2),o=!0),a=r;!o&&!(++a>=t)&&!((p=e.bMarks[a]+e.tShift[a])<(u=e.eMarks[a])&&e.tShift[a]<e.blkIndent);)"$$"===e.src.slice(p,u).trim().slice(-2)&&(l=e.src.slice(0,u).lastIndexOf("$$"),i=e.src.slice(p,l),o=!0);return e.line=a+1,(s=e.push("math_block","math",0)).block=!0,s.content=(c&&c.trim()?c+"\n":"")+e.getLines(r+1,a,e.tShift[r],!0)+(i&&i.trim()?i:""),s.map=[r,e.line],s.markup="$$",!0}function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}module.exports=function(e,r){r=r||{};e.inline.ruler.after("escape","math_inline",math_inline),e.block.ruler.after("blockquote","math_block",math_block,{alt:["paragraph","reference","blockquote","list"]}),e.renderer.rules.math_inline=function(e,t){return function(e){r.displayMode=!1;try{return katex.renderToString(e,r)}catch(t){return r.throwOnError&&console.log(t),`<span class='katex-error' title='${escapeHtml(t.toString())}'>${escapeHtml(e)}</span>`}}(e[t].content)},e.renderer.rules.math_block=function(e,t){return function(e){r.displayMode=!0;try{return"<p class='katex-block'>"+katex.renderToString(e,r)+"</p>"}catch(t){return r.throwOnError&&console.log(t),`<p class='katex-block katex-error' title='${escapeHtml(t.toString())}'>${escapeHtml(e)}</p>`}}(e[t].content)+"\n"}};